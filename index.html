<!doctype html>
<html>

<head>
    <title>Socket.IO chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font: 13px Helvetica, Arial;
        }

        form {
            background: #000;
            padding: 3px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        form input {
            border: 0;
            padding: 10px;
            width: 90%;
            margin-right: .5%;
        }

        form button {
            width: 9%;
            background: rgb(130, 224, 255);
            border: none;
            padding: 10px;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #messages li {
            padding: 5px 10px;
        }

        #messages li:nth-child(odd) {
            background: #eee;
        }
    </style>
</head>

<body>
    <ul id="messages"></ul>
    <form action="">
        <input id="m" autocomplete="off" />
        <button>Send</button>
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.0/lodash.js"></script>
    <script>
        var socket = io();

        function appendChat(msg, nickname) {
            // Sanitize user input.
            msg = _.escape(msg);

            if (nickname) {
                msg = '[<b>' + nickname + '</b>]: ' + msg;
            }
            $('#messages').append($('<li>').html(msg));
        }

        $(document).ready(function() {
            $('#messages').append($('<li>').html('Commands:'));
            $('#messages').append($('<li>').text('/name <name> - change nickname'));
        });

        var userInfo = {
            socketId: null,
            nickname: 'anonymous'
        };

        socket.on('connect', function() {
            appendChat('Connected to chat server.');
            userInfo.socketId = socket.io.engine.id;
        });
        socket.on('connect_error', function(err) {
            appendChat('Unable to connect to chat server: ' + err);
            userInfo.socketId = null;
        });
        socket.on('disconnect', function() {
            appendChat('Disconnected from chat server.');
            userInfo.socketId = null;
        });
        socket.on('client_connected', function(data) {
            appendChat('User connected: ' + data.socketId);
        });
        socket.on('client_disconnected', function(data) {
            appendChat('User disconnected: ' + data.socketId);
        });

        /**
         * Generic RPC handler.
         */
        socket.on('rpc', function(data) {
            var func = rpcMap[data.rpc];
            if (func) {
                func(data.payload);
            }
        });

        /**
         * RPC implementations.
         */
        var rpcMap = {
            chat_message: function(payload) {
                appendChat(payload.msg, payload.name);
            },
            change_nickname: function(payload) {
                var msg = '[' + payload.from + '] changed nickname to [' + payload.to + ']';
                appendChat(msg);
            }
        };

        function chat(msg) {
            socket.emit('broadcast', {
                rpc: 'chat_message',
                payload: {
                    name: userInfo.nickname,
                    msg: msg
                }
            });

            // Immediately display text for local user.
            appendChat(msg, userInfo.nickname);
        }

        function changeNickname(nickname) {
            nickname = nickname.trim();
            if (nickname) {
                socket.emit('send_all', {
                    rpc: 'change_nickname',
                    payload: {
                        from: userInfo.nickname,
                        to: nickname
                    }
                });

                userInfo.nickname = nickname;
            }
        }

        $('form').submit(function() {
            var msgText = $('#m').val();

            // Empty message.
            if (msgText === '') {
                return false;
            }

            if (_.startsWith(msgText, '/name ')) {
                changeNickname(msgText.substring(6));
            } else {
                chat(msgText);
            }

            $('#m').val('');
            return false;
        });
    </script>
</body>

</html>
